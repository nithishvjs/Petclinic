trigger:
  - main

pool:
  vmImage: 'ubuntu-latest'

steps:
  # Build WAR
  - task: Maven@3
    inputs:
      mavenPomFile: 'pom.xml'
      goals: 'clean package'
    displayName: 'Build WAR with Maven'

  # Copy WAR to staging directory
  - task: CopyFiles@2
    inputs:
      contents: '**/target/*.war'
      targetFolder: '$(Build.ArtifactStagingDirectory)'
    displayName: 'Copy WAR to staging'

  # Deploy WAR to Tomcat server via SSH
  - task: CopyFilesOverSSH@0
    inputs:
      sshEndpoint: 'Tomcat-SSH-Service'
      sourceFolder: '$(Build.ArtifactStagingDirectory)'
      contents: '*.war'
      targetFolder: '/opt/tomcat/webapps'
    displayName: 'Copy WAR to Tomcat webapps'

  # Restart Tomcat
  - task: SSH@0
    inputs:
      sshEndpoint: 'Tomcat-SSH-Service'
      runOptions: 'commands'
      command: |
        /opt/tomcat/bin/shutdown.sh || true
        sleep 3
        /opt/tomcat/bin/startup.sh
    displayName: 'Restart Tomcat'
